<!doctype html>
<html>
<head>
    <title>Test Runner</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .green { background-color: #c8f7c5; }
        .red { background-color: #f7c5c5; }
        .gray { background-color: #eeeeee; }
        ul { 
            list-style-type: none; 
            padding-left: 0; 
            margin: 0;               
            line-height: 1;          
            font-size: 14px;         
        }
        li { 
            margin: 0; 
            padding: 0;              
            line-height: 1;          
            display: block;          
        }
        a {
            display: inline-block;
            line-height: 1;
            padding: 0;
            margin: 0;
            text-decoration: none;
        }
    </style>
</head>
<body>

    <h2>Run Test</h2>
    <div id="progress-status">Progress: Idle</div>
    <button id="run-buildtests-btn">Run Build</button>
    <button id="run-playtests-btn">Run Play</button>

    <br><br>

<h1>Most Recent</h1>
{% if latest_summary %}
    <table>
        <tr><th>Test</th><th>Duration (s)</th><th>Status</th></tr>
        {% for test, duration, status in latest_summary %}
            <tr>
                <td>{{ test }}</td>
                <td>{{ duration }}</td>
                <td class="{{ 'green' if status == 'PASS' else ('red' if status == 'FAIL' else 'gray') }}">{{ status }}</td>
            </tr>
        {% endfor %}
    </table>
{% else %}
    <p>No reports found.</p>
{% endif %}


    <br><br>

<h2>Summaries</h2>
<table>
    <tr><th>Report</th><th>Duration</th><th>Status</th></tr>
    {% for report, duration, status in summaries %}
        <tr>
            <td><a href="{{ url_for('view_report', filepath=report) }}">{{ report }}</a></td>
            <td>{{ duration }}</td>
            <td class="{{ 'green' if status == 'PASS' else ('red' if status == 'FAIL' else 'gray') }}">{{ status }}</td>
        </tr>
    {% endfor %}
</table>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let polling = false;
    let pollTimeout;

    function pollProgress() {
        fetch("/progress")
            .then(response => response.text())
            .then(data => {
                const status = document.getElementById("progress-status");
                if (data === "Done") {
                    status.textContent = "Progress: Complete";
                    polling = false;
                    clearTimeout(pollTimeout);
                    location.reload();
                } else {
                    status.textContent = "Progress: " + data;
                    pollTimeout = setTimeout(pollProgress, 3000);
                }
            })
            .catch(() => {
                pollTimeout = setTimeout(pollProgress, 3000);
            });
    }

    document.getElementById("run-buildtests-btn").addEventListener("click", function() {
        if (polling) return;
        polling = true;
        document.getElementById("progress-status").textContent = "Progress: Starting Build Tests...";
        fetch("/run_build")
            .then(response => {
                if (!response.ok) throw new Error("Failed to start build tests");
                pollProgress();
            })
            .catch(err => {
                polling = false;
                document.getElementById("progress-status").textContent = "Error starting build tests";
                console.error(err);
            });
    });

    document.getElementById("run-playtests-btn").addEventListener("click", function() {
        if (polling) return;
        polling = true;
        document.getElementById("progress-status").textContent = "Progress: Starting Play Tests...";
        fetch("/run_play")
            .then(response => {
                if (!response.ok) throw new Error("Failed to start play tests");
                pollProgress();
            })
            .catch(err => {
                polling = false;
                document.getElementById("progress-status").textContent = "Error starting build tests";
                console.error(err);
            });
    });

        }); // end of DOMContentLoaded
</script>

</body>
</html>
